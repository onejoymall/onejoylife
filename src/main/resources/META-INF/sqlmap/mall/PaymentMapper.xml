<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="mall.PaymentMapper">
	<select id="getUserPaymentStatusCount" parameterType="hashmap" resultType="hashmap">
		SELECT sum(A.payment_status = 'M') as mCnt,
				 sum(A.payment_status = 'w') as wCnt,
				 sum(A.payment_status IN ('I','D')) as iCnt,
				 sum(A.payment_status = 'R') as rCnt,
				 sum(A.payment_status = 'O') as oCnt
		FROM payment A
		WHERE A.payment_user_id = #{payment_user_id}
	</select>
	
    <insert id="insertPayment" parameterType="java.util.Map">
        insert into payment(
        success,
        product_order_name,
        imp_uid,
        payment_user_id,
        merchant_uid,
        pay_method,
        pg_provider,
        pg_type,
        error_msg,
        payment_cd,
        order_no,
        product_cd,
        giveaway_cd,
        payment,
        payment_type_cd,
        payment_status,
        customs_clearance_number,
        password,
        delivery_hope_date,
        delivery_hope_time,
        payment_order_quantity,
        reg_no
        )values (
         #{success},
         #{product_order_name},
         #{imp_uid},
         #{payment_user_id},
         #{merchant_uid},
         #{pay_method},
         #{pg_provider},
         #{pg_type},
         #{error_msg},
        #{payment_cd},
        #{order_no},
        #{product_cd},
        #{giveaway_cd},
        #{payment},
        #{payment_type_cd},
        #{payment_status},
        #{customs_clearance_number},
        #{password},
        #{hope_date},
        #{hope_time},
        #{payment_order_quantity},
        #{reg_no}
        )
    </insert>

    <insert id="paymentOrders" parameterType="hashmap">
        insert into payment_bundle(
        product_cd,
        payment_cd,
        order_no,
        cart_cd,
        payment_type_cd,
        payment_order_quantity
        )values (
        #{product_cd},
        #{payment_cd},
        #{order_no},
        #{cart_cd},
        #{payment_type_cd},
        #{payment_order_quantity}
        )
    </insert>
    <insert id="insertBundle" parameterType="hashmap">
        insert into payment_bundle(
	        product_cd,
	        payment_cd,
	        order_no,
	        cart_cd,
	        payment_type_cd,
	        payment_order_quantity,
	        coupon_cd
        )values (
	        #{product_cd},
	        #{payment_cd},
	        #{order_no},
	        #{cart_cd},
	        #{payment_type_cd},
	        #{payment_order_quantity},
        	#{coupon_cd}
        )
    </insert>



    <update id="updateGiveawayDeliveryStatus" parameterType="java.util.Map">
        update giveaway_play_history set giveaway_payment_status = #{giveaway_payment_status} where giveaway_play_cd=#{giveaway_play_cd}
    </update>

    <select id="getPaymentList" resultType="java.util.HashMap">
    <![CDATA[
        SELECT
        	IF(A.product_order_name is not null,A.product_order_name,B.product_name) as product_name,
            A.*,B.*,
            (select Z.username from user Z where Z.usr_id=A.payment_user_id) as username,
            (select Z.email from user Z where Z.usr_id=A.payment_user_id) as email,
            (select Z.delivery_start_date from delivery_info Z where Z.order_no=A.order_no) as delivery_start_date,
            (select Z.delivery_t_code from delivery_info Z where Z.order_no=A.order_no) as delivery_t_code,
            (select Z.delivery_t_invoice from delivery_info Z where Z.order_no=A.order_no) as delivery_t_invoice,
            (select Z.product_made_company_name from product_made_company Z where Z.product_made_company_cd=B.product_made_company_cd) as product_made_company_name,
            (select Z.code_name from code Z where Z.code='payment_status' and Z.code_value = A.payment_status) as payment_status_name,
            (select Z.file_link from product_file Z where Z.key_id = A.product_cd and Z.file_order = 1) as file_1,
            (select Z.file_link from product_file Z where Z.key_id = A.product_cd and Z.file_order = 2) as file_2,
            (select Z.file_link from product_file Z where Z.key_id = A.product_cd and Z.file_order = 3) as file_3,
            (select Z.file_link from product_file Z where Z.key_id = A.product_cd and Z.file_order = 4) as file_4,
            (select Z.file_link from product_file Z where Z.key_id = A.product_cd and Z.file_order = 5) as file_5,
            (select Z.review_id from product_review Z where Z.order_no = A.order_no) as review_id,
            (select D.order_user_email from delivery_info D where A.order_no = D.order_no) as order_user_email
        FROM payment A left join product B on (B.product_cd = A.product_cd) where 1=1 and A.product_cd is not null
        ]]>
        <if test="searchKeyword!=null and searchKeyword!='' and searchType!=''">
	      <foreach item="item" index="index" collection="searchTypeArr" separator=" OR " open="AND (" close=")">
		  	<if test='item == "product_name"'>
		      	IF(A.product_order_name is not null,A.product_order_name,B.product_name) LIKE CONCAT('%', #{searchKeyword},'%' ) 
		    </if>
		    <if test='item != "product_name"'>
		        ${item} LIKE CONCAT('%', #{searchKeyword},'%' )
	        </if>
	      </foreach>
	    </if>
        <if test="payment_status != null and payment_status !=''"><![CDATA[AND A.payment_status = #{payment_status} ]]></if>
        <if test="start_date != null and start_date !=''"><![CDATA[AND A.reg_date >= #{start_date} ]]></if>
        <if test="end_date != null and end_date !=''"><![CDATA[AND A.reg_date <= #{end_date} ]]></if>
        <if test="delivery_start_date != null and delivery_start_date !=''"><![CDATA[AND (select Z.delivery_start_date from delivery_info Z where Z.order_no=A.order_no) >= #{delivery_start_date} ]]></if>
        <if test="delivery_end_date != null and delivery_end_date !=''"><![CDATA[AND (select Z.delivery_start_date from delivery_info Z where Z.order_no=A.order_no) <= #{delivery_end_date} ]]></if>
        <if test="merchant_uid != null"> <![CDATA[AND A.merchant_uid= #{merchant_uid} ]]></if>
        <if test="payment_user_id != null"> <![CDATA[AND A.payment_user_id= #{payment_user_id} ]]></if>
        <if test="order_no != null"> <![CDATA[AND A.order_no= #{order_no} ]]></if>
    <![CDATA[ order by A.reg_date desc LIMIT ${rowStart-1}, ${staticRowEnd} ]]>
    </select>
    <select id="getPaymentListCount" parameterType="java.util.Map" resultType="Integer">
        <![CDATA[
        SELECT
            count(*) as cnt
        FROM payment A  left join product B on (B.product_cd = A.product_cd) where 1=1
        ]]>
        <if test="searchKeyword!=null and searchKeyword!='' and searchType!=''">
	      <foreach item="item" index="index" collection="searchTypeArr" separator=" OR " open="AND (" close=")">
	        ${item} LIKE CONCAT('%', #{searchKeyword},'%' )
	      </foreach>
	    </if>
        <if test="payment_status != null and payment_status !=''"><![CDATA[AND A.payment_status = #{payment_status} ]]></if>
        <if test="start_date != null and start_date !=''"><![CDATA[AND A.reg_date >= #{start_date} ]]></if>
        <if test="end_date != null and end_date !=''"><![CDATA[AND A.reg_date <= #{end_date} ]]></if>
        <if test="delivery_start_date != null and delivery_start_date !=''"><![CDATA[AND (select Z.delivery_start_date from delivery_info Z where Z.order_no=A.order_no) >= #{delivery_start_date} ]]></if>
        <if test="delivery_end_date != null and delivery_end_date !=''"><![CDATA[AND (select Z.delivery_start_date from delivery_info Z where Z.order_no=A.order_no) <= #{delivery_end_date} ]]></if>
        <if test="merchant_uid != null"> <![CDATA[AND A.merchant_uid= #{merchant_uid} ]]></if>
        <if test="payment_user_id != null"> <![CDATA[AND A.payment_user_id= #{payment_user_id} ]]></if>
        <if test="order_no != null"> <![CDATA[AND A.order_no= #{order_no} ]]></if>
    </select>
    <select id="getPaymentDetail" resultType="java.util.HashMap" parameterType="java.util.Map" >
        <![CDATA[
        SELECT
            A.*,B.*,
            (select Z.username from user Z where Z.usr_id=A.payment_user_id) as username,
            (select Z.email from user Z where Z.usr_id=A.payment_user_id) as email,
            (select Z.delivery_start_date from delivery_info Z where Z.order_no=A.order_no) as delivery_start_date,
            (select Z.delivery_t_code from delivery_info Z where Z.order_no=A.order_no) as delivery_t_code,
            (select Z.delivery_t_invoice from delivery_info Z where Z.order_no=A.order_no) as delivery_t_invoice,
            (select Z.delivery_status from delivery_info Z where Z.order_no=A.order_no) as delivery_status,
            (select Z.code_name from code Z where Z.code='payment_status' and Z.code_value = A.payment_status) as payment_status_name,
            (select Z.product_made_company_name from product_made_company Z where Z.product_made_company_cd=B.product_made_company_cd) as product_made_company_name,
            (select Z.code_name from code Z where Z.code = 'product_payment_type' AND Z.code_value = A.pay_method) as pay_method_name,
            (select D.order_user_email from delivery_info D where A.order_no = D.order_no) as order_user_email,
            (select Z.file_link from product_file Z where Z.key_id = A.product_cd and Z.file_order = 1) as file_1,
            (select Z.file_link from product_file Z where Z.key_id = A.product_cd and Z.file_order = 2) as file_2,
            (select Z.file_link from product_file Z where Z.key_id = A.product_cd and Z.file_order = 3) as file_3,
            (select Z.file_link from product_file Z where Z.key_id = A.product_cd and Z.file_order = 4) as file_4,
            (select Z.file_link from product_file Z where Z.key_id = A.product_cd and Z.file_order = 5) as file_5
        FROM payment A left join product B on (B.product_cd = A.product_cd) where 1=1
        ]]>
        <if test="payment_user_id != null"> <![CDATA[AND A.payment_user_id= #{payment_user_id} ]]></if>
        <if test="merchant_uid != null"> <![CDATA[AND A.merchant_uid= #{merchant_uid} ]]></if>
        <if test="order_no != null"> <![CDATA[AND A.order_no= #{order_no} ]]></if>
    </select>
    <select id="getTodaySummary" resultType="java.util.HashMap" parameterType="java.util.Map" >
	    SELECT IFNULL(COUNT(*),0) orderCnt,
				IFNULL(COUNT(*),0) - IFNULL(SUM(A.payment_status IN ('C','G')),0) payCnt,
				IFNULL(SUM(A.payment_status ='C'),0) refundCnt,
				SUM(IFNULL(payment,0)) orderTotal, 
				SUM(IFNULL(A.payment,0))-SUM(IFNULL(IF(A.payment_status IN ('C','G'),A.payment,0),0)) payTotal, 
				SUM(IFNULL(IF(A.payment_status IN ('C','G'),A.payment,0),0)) refundTotal
		FROM payment A
		WHERE DATE_FORMAT(A.reg_date,'%Y%m%d') = DATE_FORMAT(SYSDATE(),'%Y%m%d')
    </select>
    <select id="getLastMonthSummary" resultType="java.util.HashMap" parameterType="java.util.Map" >
	    SELECT SUM(IF(A.payment_status = 'M',1,0)) mCnt,
				SUM(IF(A.payment_status IN ('D','I','W'),1,0)) dCnt,
				SUM(IF(A.payment_status = 'R',1,0)) rCnt,
				SUM(IF(A.payment_status = 'O',1,0)) oCnt,
				SUM(IF(A.payment_status = 'C',1,0)) cCnt,
				SUM(IF(A.payment_status IN ('F','S'),1,0)) sCnt,
				SUM(IF(A.payment_status = 'H',1,0)) hCnt,
				SUM(IF(A.payment_status = 'G',1,0)) gCnt
		FROM payment A
		WHERE A.reg_date BETWEEN DATE_ADD(SYSDATE(), INTERVAL -1 MONTH) AND SYSDATE()
    </select>
    <select id="getStatusCount" resultType="java.util.HashMap" parameterType="java.util.Map" >
	    SELECT SUM(IF(A.payment_status = 'M',1,0)) mCnt,
				SUM(IF(A.payment_status = 'D',1,0)) dCnt,
				SUM(IF(A.payment_status = 'I',1,0)) iCnt,
				SUM(IF(A.payment_status = 'W',1,0)) wCnt,
				SUM(IF(A.payment_status = 'R',1,0)) rCnt,
				SUM(IF(A.payment_status = 'O',1,0)) oCnt,
				SUM(IF(A.payment_status = 'C',1,0)) cCnt,
				SUM(IF(A.payment_status = 'F',1,0)) fCnt,
				SUM(IF(A.payment_status = 'S',1,0)) sCnt,
				SUM(IF(A.payment_status = 'H',1,0)) hCnt,
				SUM(IF(A.payment_status = 'G',1,0)) gCnt
		FROM payment A
		WHERE 1=1
		<if test="start_date != null and start_date !=''"><![CDATA[AND A.reg_date >= #{start_date} ]]></if>
        <if test="end_date != null and end_date !=''"><![CDATA[AND A.reg_date <= #{end_date} ]]></if>
    </select>
    <update id="updatePayment" parameterType="com.webapp.mall.vo.DeliveryInfoVO">
        update payment set
        payment_status = #{payment_status}
        where order_no=#{merchant_uid}
    </update>
    <update id="updatePaymentManger" parameterType="com.webapp.mall.vo.DeliveryInfoVO">
        update payment set
        payment_status = #{payment_status}
        where order_no=#{order_no}
    </update>
    <insert id="insertPaymentRefund" parameterType="com.webapp.mall.vo.DeliveryInfoVO">
        insert into payment_refund
        (
            merchant_uid,
            cancel_request_amount,
            reason,
            refund_holder,
            refund_bank,
            refund_account
        )values(
            #{merchant_uid},
            #{cancel_request_amount},
            #{reason},
            #{refund_holder},
            #{refund_bank},
            #{refund_account}
        )
    </insert>
</mapper>
