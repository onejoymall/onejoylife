<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="mall.MgSalesMapper">
  <select id="getCategorySalesListCount" resultType="Integer">
    SELECT IFNULL(COUNT(*),0) cnt
    FROM (SELECT  DATE_FORMAT(A.reg_date,'%Y.%m.%d') reg_date,
			D.pd_category_name
	FROM payment A
	LEFT JOIN payment_refund E
	ON A.order_no = E.order_id
	left JOIN product C
	ON A.product_CD = C.product_CD
	left JOIN product_category D
	ON D.pd_category_id = SUBSTRING_INDEX(C.product_ct,'|',1) 
	where 1=1
    <if test="searchKeyword!=null and searchKeyword!='' and searchType!=''">
      <foreach item="item" index="index" collection="searchTypeArr" separator=" OR " open="AND (" close=")">
        ${item} LIKE CONCAT('%', #{searchKeyword},'%' )
      </foreach>
    </if>
    <if test="start_date != null"><![CDATA[AND A.reg_date >= #{start_date} ]]></if>
    <if test="end_date != null"><![CDATA[AND A.reg_date < #{end_date} ]]></if>
    GROUP BY 1,2) A
  </select>
  <select id="getCategorySalesList" resultType="java.util.HashMap">
    SELECT  DATE_FORMAT(A.reg_date,'%Y.%m.%d') reg_date,
			D.pd_category_name,
			ifnull(sum(payment_order_quantity),0) payment_order_quantity,
			ifnull(COUNT(distinct C.product_id),0) product_count,
			ifnull(sum(C.product_user_payment*A.payment_order_quantity),0) product_user_payment,
			ifnull(SUM((C.product_user_payment-C.product_payment)*A.payment_order_quantity),0) product_discount,
			ifnull(sum(E.cancel_request_amount),0) cancel_request_amount
	FROM payment A
	LEFT JOIN payment_refund E
	ON A.order_no = E.order_id
	left JOIN product C
	ON A.product_CD = C.product_CD
	left JOIN product_category D
	ON D.pd_category_id = SUBSTRING_INDEX(C.product_ct,'|',1) 
	where 1=1
    <if test="searchKeyword!=null and searchKeyword!='' and searchType!=''">
      <foreach item="item" index="index" collection="searchTypeArr" separator=" OR " open="AND (" close=")">
        ${item} LIKE CONCAT('%', #{searchKeyword},'%' )
      </foreach>
    </if>
    <if test="start_date != null"><![CDATA[AND A.reg_date >= #{start_date} ]]></if>
    <if test="end_date != null"><![CDATA[AND A.reg_date < #{end_date} ]]></if>
    GROUP BY 1,2
	<![CDATA[ order by A.reg_date desc LIMIT ${rowStart-1}, ${staticRowEnd} ]]>
  </select>
</mapper>
