<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="mall.CouponMapper">

    <select id="getCouponList" resultType="java.util.HashMap">
        <![CDATA[
        SELECT
          *
        FROM coupon  where 1=1
        ]]>

        <if test="coupon_id != null"> <![CDATA[AND coupon_id= #{coupon_id} ]]></if>
        <if test="coupon_cd != null"> <![CDATA[AND coupon_cd= #{coupon_cd} ]]></if>
        <if test="coupon_name != null"> <![CDATA[AND coupon_name like CONCAT('%',#{coupon_name},'%') ]]></if>
        <if test="start_date != null"><![CDATA[AND reg_date >= #{start_date} ]]></if>
        <if test="end_date != null"><![CDATA[AND reg_date < #{end_date} ]]></if>
        <if test="coupon_use_yn != null"> <![CDATA[AND coupon_use_yn= #{coupon_use_yn} ]]></if>
    </select>
    <select id="getCouponListCount" resultType="java.util.HashMap">
        <![CDATA[
        SELECT
            count(*) as cnt
        FROM coupon  where 1=1
        ]]>

        <if test="coupon_id != null"> <![CDATA[AND coupon_id= #{coupon_id} ]]></if>
        <if test="coupon_cd != null"> <![CDATA[AND coupon_cd= #{coupon_cd} ]]></if>
        <if test="coupon_name != null"> <![CDATA[AND coupon_name like CONCAT('%',#{coupon_name},'%') ]]></if>
        <if test="start_date != null"><![CDATA[AND reg_date >= #{start_date} ]]></if>
        <if test="end_date != null"><![CDATA[AND reg_date < #{end_date} ]]></if>
        <if test="coupon_use_yn != null"> <![CDATA[AND coupon_use_yn= #{coupon_use_yn} ]]></if>
    </select>
    <select id="getUserCouponList" resultType="java.util.HashMap">
        <![CDATA[
        SELECT
            A.*,
            (SELECT DATE_ADD(A.reg_date, INTERVAL (select Z.coupon_use_day from coupon Z  where Z.coupon_id=A.coupon_id) DAY)) as coupon_use_day,
            (select Z.coupon_name from coupon Z where Z.coupon_id=A.coupon_id) as coupon_name,
            (select Z.coupon_payment_condition from coupon Z where Z.coupon_id=A.coupon_id) as coupon_payment_condition,
            (select Z.coupon_cd from coupon Z where Z.coupon_id=A.coupon_id) as coupon_cd
        FROM coupon_paid_history A  where 1=1
        ]]>

        <if test="coupon_paid_id != null"> <![CDATA[AND A.coupon_paid_id= #{coupon_id} ]]></if>
        <if test="coupon_cd != null"> <![CDATA[AND coupon_cd= #{coupon_cd} ]]></if>
        <if test="coupon_name != null"> <![CDATA[AND coupon_name like CONCAT('%',#{coupon_name},'%') ]]></if>
        <if test="start_date != null"><![CDATA[AND A.reg_date >= #{start_date} ]]></if>
        <if test="end_date != null"><![CDATA[AND A.reg_date < #{end_date} ]]></if>
        <if test="coupon_paid_class_cd != null"> <![CDATA[AND A.coupon_paid_class_cd= #{coupon_paid_class_cd} ]]></if>
        <if test="coupon_paid_user_id != null"> <![CDATA[AND A.coupon_paid_user_id= #{coupon_paid_user_id} ]]></if>
    </select>
    <select id="getUserCouponListCount" resultType="java.util.HashMap">
        <![CDATA[
        SELECT
            count(*) as cnt
        FROM coupon_paid_history A  where 1=1
        ]]>

        <if test="coupon_paid_id != null"> <![CDATA[AND A.coupon_paid_id= #{coupon_id} ]]></if>
        <if test="coupon_cd != null"> <![CDATA[AND coupon_cd= #{coupon_cd} ]]></if>
        <if test="coupon_name != null"><![CDATA[AND coupon_name like CONCAT('%',#{coupon_name},'%') ]]></if>
        <if test="start_date != null"><![CDATA[AND A.reg_date >= #{start_date} ]]></if>
        <if test="end_date != null"><![CDATA[AND A.reg_date < #{end_date} ]]></if>
        <if test="coupon_paid_class_cd != null"> <![CDATA[AND A.coupon_paid_class_cd= #{coupon_paid_class_cd} ]]></if>
    </select>

    <insert id="insertCoupon" parameterType="String">
        <![CDATA[
        insert into coupon(
        coupon_cd,coupon_name,coupon_payment,coupon_use_yn)
      VALUES (
        #{coupon_cd},
        #{coupon_name},
        #{coupon_payment},
        #{coupon_use_yn}
        )
        ]]>
    </insert>
    <insert id="insertCouponPaidHistory" parameterType="String">
        <![CDATA[
        insert into coupon_paid_history(
        coupon_id,coupon_paid_user_id,coupon_paid_class_cd)
      VALUES (
        #{coupon_id},
        #{coupon_paid_user_id},
        #{coupon_paid_class_cd}
        )
        ]]>
    </insert>
    <update id="updateCoupon" parameterType="java.util.Map">
        <foreach collection="list" item="item" separator=";" open="DECLARE BEGIN" close="; END;">
            <![CDATA[
            update coupon set
            coupon_cd=#{item.coupon_cd},coupon_name=#{item.coupon_name},coupon_payment=#{item.coupon_payment},coupon_use_yn=#{item.coupon_use_yn}
            where coupon_id = #{item.coupon_id}
            ]]>
        </foreach>
    </update>
    <delete id="deleteCoupon" parameterType="java.util.Map">
        <foreach collection="list" item="item" separator=";" open="DECLARE BEGIN" close="; END;">
        <![CDATA[
        delete coupon where coupon_id = #{item.coupon_id}
        ]]>
        </foreach>
    </delete>
</mapper>
